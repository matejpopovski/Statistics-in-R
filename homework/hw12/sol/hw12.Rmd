---
author: "YOUR NAME HERE"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, fig.height = 4)
library(tidyverse)
library(modelr)
source("../../scripts/viridis.R")
source("../../scripts/ggprob.R")
```

\renewcommand{\prob}{\mathsf{P}}
\newcommand{\E}{\mathsf{E}}
\newcommand{\Var}{\mathsf{Var}}
\newcommand{\SD}{\mathsf{SD}}
\newcommand{\SE}{\mathsf{SE}}

## Homework Assignment 12

### Preliminaries

- Directories
    - COURSE/homework/
    - COURSE/homework/hw12/
    - COURSE/data/
    - COURSE/scripts/
- Files
  - COURSE/homework/hw12/hw12.Rmd
  - COURSE/data/boston-marathon-data.csv
  - COURSE/data/lake-monona-winters.csv
  - COURSE/data/dugong.csv
  - COURSE/scripts/viridis.R
  - COURSE/scripts/ggprob.R

### Data

- Some problems use the data set on lengths and ages of a sample of dugongs in the file `dugong.csv`.
- Other problems use the Boston Marathon data in the file `boston-marathon-data.csv`.
- Additional problems use data from freeze durations in Lake Monona which we also saw earlier in the semester.

### Aims

- Practice regression inference

## Problems

Problems 1--3 are based on the data set in the file *dugong.csv* which relates age (in years) and length (in meters) of a sample of 27 dugongs, a type of marine mammal.

Credit:  The *dugong.csv* file is from Data8 at UC-Berkeley.

### 1.
Read in the dugong data set.
Calculate and interpret in context a 95% confidence interval for the average age of all dugongs in the population from which the data was sampled with a length of 2.5 meters.

```{r}
dugong = read_csv("../../data/dugong.csv")
dugong
model <- lm(Age ~ Length, data = dugong)

# Predict for a specific length of 2.5 meters with confidence interval
new_data <- data.frame(Length = 2.5)
conf_int <- predict(model, newdata = new_data, interval = "confidence", level = 0.95)
conf_int
```

### 2.
Calculate and interpret in context a 95% prediction interval for the age of a single dugong which measures 2.5 meters in length.
```{r}
pred_int <- predict(model, newdata = new_data, interval = "prediction", level = 0.95)
pred_int
```


### 3.
Graph the dugong data with length on the x axis and age on the y axis.

- Add a blue ribbon which shows the widths of 95% prediction intervals for individual ages over the range of lengths

- Add a red ribbon which shows the widths of 95% confidence intervals for mean ages over the range of lengths.

- Add a plot of the least-squares regression line.

```{r}
lengths <- seq(min(dugong$Length), max(dugong$Length), length.out = 100)
new_data <- data.frame(Length = lengths)

intervals <- predict(model, newdata = new_data, interval = "prediction", level = 0.95)
conf_intervals <- predict(model, newdata = new_data, interval = "confidence", level = 0.95)

interval_data <- data.frame(
  Length = lengths,
  Mean_Age = (conf_intervals[, "lwr"] + conf_intervals[, "upr"]) / 2,
  SD_Age = (conf_intervals[, "upr"] - conf_intervals[, "lwr"]) / 2
)

ggplot(interval_data, aes(x = Length, y = Mean_Age)) +
  geom_point(data = dugong, aes(x = Length, y = Age)) + # Original data points
  geom_line(size = 1.5, color = "blue") + # Mean regression line
  geom_line(aes(y = Mean_Age + SD_Age), linetype = "dashed", color = "red") +
  geom_line(aes(y = Mean_Age - SD_Age), linetype = "dashed", color = "red") +
  geom_ribbon(aes(ymin = Mean_Age - SD_Age, 
                  ymax = Mean_Age + SD_Age), 
                  alpha = 0.2) +
  labs(title = "Dugong Length vs. Age", 
       x = "Length (meters)", 
       y = "Age (years)", 
       color = "Parameter") +
  theme_bw() 
```

> Note: The function `geom_ribbon()` takes arguments `x`, `ymin`, and `ymax`. For each `x`, the area between `ymin` and `ymax` is filled. You may choose to create a supplementary data frame for x values ranging from values which span the data and are uniformly spread out and then calculate `ymin` and `ymax` using formulas from lecture notes on prediction and confidence intervals.


Problems 4--6 use the Lake Monona freeze duration data.



### 4.
Read the Lake Monona Data.

-4a. Plot `duration` versus `year1` and add a regression line.

```{r}
monona = read_csv("../../data/lake-monona-winters-2023.csv")
monona

# Plot with a regression line
ggplot(monona, aes(x = year1, y = duration)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Duration of Ice Cover on Lake Monona by Year",
       x = "Year",
       y = "Duration of Ice Cover (days)") 
```

-4b. Create a residual plot.

```{r}
model <- lm(duration ~ year1, data = monona)

# Create a dataframe of residuals
residuals_df <- data.frame(year1 = monona$year1, residuals = resid(model))

# Plot the residuals
ggplot(residuals_df, aes(x = year1, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Residual Plot for Duration of Ice Cover",
       x = "Year",
       y = "Residuals")
```

-4c. What does the residual plot suggest about the suitability of using a linear regression model and the year to predict the duration that Lake Monona's surface is covered with ice?

> If the residual plot shows random scatter around the horizontal line at zero, it indicates that a linear model may be suitable for describing the relationship between year and ice cover duration on Lake Monona

### 5.
Create and interpret a 95% confidence interval for the slope of the regression line which models `duration` versus `year1`.
```{r}
model <- lm(duration ~ year1, data = monona)

# Calculate the 95% confidence interval for the slope
slope_conf_int <- confint(model, "year1", level = 0.95)
slope_conf_int
```


### 6.

-6a. Create a table with the endpoints of 95% prediction intervals for the total duration that Lake Monona's surface is covered by ice in the years 2030, 2040, \ldots, 2100.
Print the table

```{r}
future_years <- data.frame(year1 = seq(2030, 2100, by = 10))

prediction_intervals <- predict(model, newdata = future_years, interval = "prediction", level = 0.95)

predicted_data <- cbind(future_years, prediction_intervals)

predicted_data
```

-6b. Comment on the suitability of extrapolating the linear relationship of duration versus time for Lake Monona freeze data 70 years into the future.

> Extrapolating the linear relationship for predicting the duration of ice cover on Lake Monona 70 years into the future is risky due to potential non-linearity and changing environmental conditions over long periods, especially given the significant climatic and ecological changes affecting freeze durations.



Problems 7--8 use the Boston Marathon data.



### 7.
Read the Boston Marathon data.

-7a. Create a 95% prediction interval for the finishing time of a 40-year-old man using the data from all male finishers in the 2010 race.

```{r}
boston = read_csv("../../data/boston-marathon-data.csv")

boston_2010_males <- boston %>% 
  filter(Year == 2010, Sex == "male")

model <- lm(Time ~ Age, data = boston_2010_males)

new_data <- data.frame(Age = 40)
prediction_interval_40 <- predict(model, newdata = new_data, interval = "prediction", level = 0.95)
prediction_interval_40
```


-7b. What proportion of 40-year-old men finishers in the 2011 race have times within this prediction interval?

```{r}
boston_2011_40yr_males <- boston %>%
  filter(Year == 2011, Sex == "male", Age == 40)

within_interval <- boston_2011_40yr_males %>%
  summarize(Count = sum(Time >= prediction_interval_40[1] & Time <= prediction_interval_40[3]))

total_40yr_males_2011 <- nrow(boston_2011_40yr_males)
proportion_within_interval <- within_interval$Count / total_40yr_males_2011
proportion_within_interval
```

-7c. Which assumptions of a linear model might be violated in this data and potentially cause the 95% prediction interval in 7a to be misleading?

> The finishing times could vary non-uniformly across different ages, and the distribution of times might not be normal, especially if there are outliers or the data is skewed, which could lead to misleading prediction intervals.

### 8.

-8a. Create a 95% confidence interval for the mean finish time of all 40-year-old women using data from the 2010 Boston marathon.

```{r}
boston_2010_40yr_women <- boston %>%
  filter(Year == 2010, Sex == "female", Age == 40)

model_40yr_women <- lm(Time ~ 1, data = boston_2010_40yr_women)

conf_int_40yr_women <- confint(model_40yr_women, level = 0.95)
conf_int_40yr_women
```

-8b. Using data from the 2011 Boston Marathon, calculate the sample mean finish time of all 40-year-old women. Is it in the previous interval?

```{r}
boston_2011_40yr_women <- boston %>%
  filter(Year == 2011, Sex == "female", Age == 40)

mean_2011_40yr_women <- mean(boston_2011_40yr_women$Time)
mean_2011_40yr_women
```

-8c. Using the data from the 2011 Boston Marathon,
fit a regression line of finishing time versus age for women finishers and calculate the value of the finishing time at age 40 for this line.
Is this value within the interval in part 8a?

```{r}
boston_2011_women <- boston %>%
  filter(Year == 2011, Sex == "female")

age_model_2011_women <- lm(Time ~ Age, data = boston_2011_women)

predict_data <- data.frame(Age = 40)
predicted_time_at_40 <- predict(age_model_2011_women, newdata = predict_data, interval = "confidence")
predicted_time_at_40
```

-8d. Which assumptions of a linear model might be violated and potentially cause the confidence interval in 8b to be misleading?

> The linear model's assumptions that might be violated and cause the confidence interval to be misleading include heteroscedasticity and nonlinearity, particularly if the variance of finish times differs significantly across age groups or if the relationship between age and finish time is not strictly linear.

